@model List<MVC_project.ViewModels.TripDashboardViewModel>

@{
    ViewData["Title"] = "Search Trips";
}

<style>
    /* Animated Background - matching existing design */
    .dashboard-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(-45deg, #6366f1, #3730a3, #a78bfa, #6366f1);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        z-index: -1;
    }

    @@keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* Floating particles - matching existing design */
    .particle {
        position: fixed;
        pointer-events: none;
        opacity: 0.5;
        animation: float 20s infinite linear;
        z-index: -1;
    }

    @@keyframes float {
        0% {
            transform: translate(0, 0) rotate(0deg);
            opacity: 0;
        }
        10% {
            opacity: 0.5;
        }
        90% {
            opacity: 0.5;
        }
        100% {
            transform: translate(100px, -100vh) rotate(360deg);
            opacity: 0;
        }
    }

    /* Main container */
    .trips-container {
        position: relative;
        min-height: 100vh;
        padding: 2rem 1rem;
        overflow-y: auto;
    }

    /* Page header */
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        animation: slideInDown 0.8s ease-out;
    }

    .page-title {
        color: white;
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    @@keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Grid layout for trip cards */
    .trips-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    @@media (max-width: 768px) {
        .trips-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Trip card - matching existing card design */
    .trip-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 1.5rem;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 20px 70px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        transition: all 0.3s ease;
        animation: slideInUp 0.8s ease-out;
        position: relative;
    }

    .trip-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.3);
    }

    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Trip image */
    .trip-image-container {
        width: 100%;
        height: 250px;
        overflow: hidden;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        position: relative;
    }

    .trip-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .trip-card:hover .trip-image {
        transform: scale(1.1);
    }

    .no-image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    }

    .no-image-placeholder i {
        font-size: 4rem;
        color: #0284c7;
        opacity: 0.5;
    }

    /* Trip details */
    .trip-details {
        padding: 1.5rem;
    }

    .trip-destination {
        color: #1e293b;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .trip-country {
        color: #64748b;
        font-size: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .trip-country i {
        color: #6366f1;
    }

    .trip-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #475569;
        font-size: 0.95rem;
    }

    .info-item i {
        color: #6366f1;
        width: 20px;
    }

    .trip-description {
        color: #64748b;
        font-size: 0.9rem;
        line-height: 1.6;
        margin-bottom: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Price section */
    .trip-price-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 1rem;
        border-top: 2px solid #e2e8f0;
    }

    .price-container {
        display: flex;
        flex-direction: column;
    }

    .trip-price {
        color: #1e293b;
        font-size: 1.8rem;
        font-weight: 700;
    }

    .original-price {
        color: #94a3b8;
        font-size: 1rem;
        text-decoration: line-through;
    }

    .discount-badge {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
    }

    /* Package type badge */
    .package-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        z-index: 1;
    }

    /* Expand button */
    .expand-btn {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 2;
    }

    .expand-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
    }

    /* Trip Modal Overlay */
    .trip-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(99, 102, 241, 0.15), rgba(0, 0, 0, 0.95));
        backdrop-filter: blur(10px);
        z-index: 9998;
        overflow-y: auto;
    }

    .trip-modal.active {
        display: block;
        animation: modalBackdropFadeIn 0.4s ease;
    }

    .modal-content {
        max-width: 1200px;
        margin: 2rem auto;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.98) 100%);
        border-radius: 2rem;
        padding: 2.5rem;
        position: relative;
        box-shadow: 0 40px 100px rgba(99, 102, 241, 0.3), 
                    0 20px 60px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.5);
        transform-origin: center;
    }

    /* Modal quantity row responsiveness */
    .modal-qty-row {
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .qty-control { 
        min-width: 160px;
    }

    @@media (max-width: 700px) {
        .modal-content { padding: 1rem; margin: 1rem; }
        .modal-qty-row { gap: 0.5rem; }
        .qty-control { min-width: 120px; }
    }

    .modal-content.expand-animation {
        animation: expandFromCard 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-content::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #6366f1, #a78bfa, #6366f1);
        border-radius: 2rem;
        z-index: -1;
        opacity: 0.3;
        filter: blur(20px);
    }

    .modal-close {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 10;
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    .modal-close:hover {
        transform: rotate(90deg) scale(1.15);
        box-shadow: 0 12px 30px rgba(239, 68, 68, 0.6);
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    }

    .modal-close:active {
        transform: rotate(90deg) scale(1.05);
    }

    /* Photo Carousel */
    .photo-carousel {
        position: relative;
        width: 100%;
        margin-bottom: 2rem;
    }

    .carousel-main {
        position: relative;
        width: 100%;
        height: 500px;
        background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 50%, #e0f2fe 100%);
        border-radius: 1.5rem;
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: inset 0 2px 20px rgba(99, 102, 241, 0.1),
                    0 10px 40px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .carousel-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none;
    }

    .carousel-image.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .carousel-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
        color: #6366f1;
        border: 2px solid rgba(99, 102, 241, 0.2);
        width: 56px;
        height: 56px;
        border-radius: 50%;
        font-size: 1.6rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 5;
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3),
                    0 4px 10px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
    }

    .carousel-arrow:hover {
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        color: white;
        border-color: transparent;
        transform: translateY(-50%) scale(1.15);
        box-shadow: 0 12px 35px rgba(99, 102, 241, 0.5),
                    0 6px 15px rgba(0, 0, 0, 0.3);
    }

    .carousel-arrow:active {
        transform: translateY(-50%) scale(1.05);
    }

    .carousel-arrow.prev {
        left: 1rem;
    }

    .carousel-arrow.next {
        right: 1rem;
    }

    .carousel-counter {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    /* Thumbnail Strip */
    .carousel-thumbnails {
        display: flex;
        gap: 0.75rem;
        overflow-x: auto;
        padding: 0.5rem;
        background: rgba(248, 250, 252, 0.8);
        border-radius: 0.75rem;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .carousel-thumbnails::-webkit-scrollbar {
        height: 6px;
    }

    .carousel-thumbnails::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .carousel-thumbnails::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .thumbnail {
        min-width: 100px;
        width: 100px;
        height: 80px;
        object-fit: cover;
        border-radius: 0.5rem;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s ease;
        opacity: 0.6;
    }

    .thumbnail:hover {
        opacity: 1;
        transform: scale(1.05);
    }

    .thumbnail.active {
        border-color: #6366f1;
        opacity: 1;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .carousel-loading,
    .carousel-empty {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 1.2rem;
    }

    /* Modal trip details */
    .modal-trip-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 3px solid transparent;
        background: linear-gradient(white, white) padding-box,
                    linear-gradient(90deg, #6366f1, #a78bfa, #6366f1) border-box;
        border-image: linear-gradient(90deg, #6366f1, #a78bfa, #6366f1) 1;
    }

    .modal-trip-title {
        color: #1e293b;
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.75rem;
        background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .modal-trip-location {
        color: #6366f1;
        font-size: 1.3rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .modal-trip-location i {
        font-size: 1.5rem;
        animation: pulse 2s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .modal-trip-description {
        color: #475569;
        font-size: 1rem;
        line-height: 1.8;
        margin-bottom: 1rem;
    }

    /* Additional trip details */
    .additional-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Expand button */
    .expand-btn {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 2;
    }

    .expand-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
    }

    .expand-btn i {
        transition: transform 0.3s ease;
    }

    .trip-card.expanded .expand-btn i {
        transform: rotate(180deg);
    }

    /* Expanded content */
    .expanded-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
        padding: 0 1.5rem;
    }

    .trip-card.expanded .expanded-content {
        max-height: 2000px;
        padding: 1.5rem;
        border-top: 2px solid #e2e8f0;
    }

    /* Photo gallery */
    .photo-gallery {
        margin-bottom: 1.5rem;
    }

    .photo-gallery h4 {
        color: #1e293b;
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .photo-gallery h4 i {
        color: #6366f1;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }

    .gallery-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .gallery-image:hover {
        transform: scale(1.05);
        border-color: #6366f1;
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
    }

    .gallery-loading {
        text-align: center;
        padding: 2rem;
        color: #64748b;
    }

    .gallery-empty {
        text-align: center;
        padding: 2rem;
        color: #94a3b8;
        font-style: italic;
    }

    /* Additional trip details */
    .additional-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .detail-item {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 1rem;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
    }

    .detail-item strong {
        color: #6366f1;
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .detail-item span {
        color: #1e293b;
        font-size: 1rem;
        font-weight: 600;
    }

    /* Action buttons */
    .trip-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .btn-action {
        flex: 1;
        min-width: 150px;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-add-cart {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .btn-add-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
    }

    .btn-book-now {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }

    .btn-book-now:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
    }

    /* Date Variations Section */
    .date-variations-section {
        padding: 1.5rem;
        margin: 1.5rem 0;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 1rem;
        border: 2px solid #e2e8f0;
    }

    .date-variations-list {
        display: grid;
        gap: 0.75rem;
    }

    .date-variation-item {
        background: white;
        padding: 1rem;
        border-radius: 0.75rem;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .date-variation-item:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        transform: translateY(-2px);
    }

    .date-variation-info {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .date-variation-info > div {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #475569;
        font-size: 0.95rem;
    }

    .date-variation-info i {
        color: #6366f1;
    }

    .date-variation-info strong {
        font-weight: 600;
        color: #1e293b;
    }

    /* Image lightbox */
    .lightbox {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        animation: fadeIn 0.3s ease;
    }

    .lightbox.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .lightbox-content {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 0.5rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .lightbox-close {
        position: absolute;
        top: 2rem;
        right: 3rem;
        color: white;
        font-size: 3rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .lightbox-close:hover {
        color: #6366f1;
        transform: scale(1.2);
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes modalBackdropFadeIn {
        from {
            opacity: 0;
            backdrop-filter: blur(0px);
        }
        to {
            opacity: 1;
            backdrop-filter: blur(10px);
        }
    }

    @@keyframes expandFromCard {
        from {
            opacity: 0;
            transform: translate(var(--start-x), var(--start-y)) scale(0.3);
            border-radius: 1.5rem;
        }
        to {
            opacity: 1;
            transform: translate(0, 0) scale(1);
            border-radius: 2rem;
        }
    }

    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@media (max-width: 768px) {
        .modal-content {
            margin: 1rem;
            padding: 1.5rem;
        }

        .carousel-main {
            height: 300px;
        }

        .carousel-arrow {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }

        .thumbnail {
            min-width: 80px;
            width: 80px;
            height: 60px;
        }
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 2rem;
        max-width: 600px;
        margin: 0 auto;
        box-shadow: 0 20px 70px rgba(0, 0, 0, 0.2);
    }

    .empty-state i {
        font-size: 5rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
    }

    .empty-state h2 {
        color: #1e293b;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #64748b;
        font-size: 1.1rem;
    }

    /* Filter Panel */
    .filter-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 1.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 20px 70px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        overflow-x: auto;
    }

    .filter-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .filter-title {
        color: #1e293b;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-title i {
        color: #6366f1;
    }

    .filter-toggle {
        display: flex;
        gap: 0.5rem;
    }

    .filter-toggle button {
        background: transparent;
        border: 2px solid #e2e8f0;
        color: #475569;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .filter-toggle button.active {
        background: #6366f1;
        color: white;
        border-color: #6366f1;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
        grid-auto-flow: dense;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 0;
    }

    .filter-label {
        color: #334155;
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-label i {
        color: #6366f1;
        flex-shrink: 0;
    }

    .filter-input, .filter-select {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        min-width: 0;
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .sort-controls {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .sort-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1;
        min-width: 200px;
    }

    .sort-label {
        color: #334155;
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sort-label i {
        color: #6366f1;
    }

    .filter-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    .btn-filter {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-apply {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .btn-apply:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
    }

    .btn-reset {
        background: transparent;
        color: #475569;
        border: 2px solid #e2e8f0;
    }

    .btn-reset:hover {
        border-color: #6366f1;
        color: #6366f1;
    }

    .trip-count {
        color: #64748b;
        font-size: 1rem;
        font-weight: 600;
    }

    .trip-count strong {
        color: #6366f1;
    }

    /* Discount badge on filter */
    .discount-checkbox {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .discount-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .discount-checkbox label {
        cursor: pointer;
        margin-bottom: 0;
        font-weight: 500;
    }

    @@media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }

        .filter-panel {
            padding: 1.5rem;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        .filter-buttons {
            justify-content: center;
        }

        .sort-group {
            min-width: 100%;
        }
    }
</style>

<!-- Animated Background -->
<div class="dashboard-bg"></div>

<!-- Floating particles -->
<script>
    for (let i = 0; i < 15; i++) {
        let particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.width = Math.random() * 5 + 2 + 'px';
        particle.style.height = particle.style.width;
        particle.style.left = Math.random() * 100 + '%';
        particle.style.background = 'white';
        particle.style.borderRadius = '50%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = Math.random() * 10 + 15 + 's';
        document.body.appendChild(particle);
    }
</script>

<div class="trips-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-search"></i> Search Trips
        </h1>
        <p class="page-subtitle">Find your perfect destination with our advanced filters</p>
    </div>

    @if (Model == null || !Model.Any())
    {
        <!-- Empty State -->
        <div class="empty-state">
            <i class="bi bi-compass"></i>
            <h2>No Trips Available</h2>
            <p>Check back soon for exciting new destinations!</p>
        </div>
    }
    else
    {
        <!-- Filter Panel -->
        <div class="filter-panel">
            <div class="filter-header">
                <h2 class="filter-title">
                    <i class="bi bi-funnel"></i> Filter & Sort Trips
                </h2>
                <div class="trip-count">
                    Showing <strong id="tripCount">@Model.Count()</strong> trips
                </div>
            </div>

            <form id="filterForm" method="get" action="@Url.Action("Search", "Filter")">
                <div class="filter-grid">
                    <!-- Destination Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-geo-alt"></i> Destination
                        </label>
                        <input type="text" id="destination" name="destination" class="filter-input" placeholder="e.g., Paris, Tokyo..." value="@Context.Request.Query["destination"]">
                    </div>

                    <!-- Country Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-flag"></i> Country
                        </label>
                        <input type="text" id="country" name="country" class="filter-input" placeholder="e.g., France, Japan..." value="@Context.Request.Query["country"]">
                    </div>

                    <!-- Category Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-box"></i> Category
                        </label>
                        <select id="category" name="category" class="filter-select">
                            <option value="">All Categories</option>
                            <option value="Family" selected="@(Context.Request.Query["category"] == "Family")">Family</option>
                            <option value="Honeymoon" selected="@(Context.Request.Query["category"] == "Honeymoon")">Honeymoon</option>
                            <option value="Adventure" selected="@(Context.Request.Query["category"] == "Adventure")">Adventure</option>
                            <option value="Cruise" selected="@(Context.Request.Query["category"] == "Cruise")">Cruise</option>
                            <option value="Luxury" selected="@(Context.Request.Query["category"] == "Luxury")">Luxury</option>
                            <option value="Budget" selected="@(Context.Request.Query["category"] == "Budget")">Budget</option>
                            <option value="Group" selected="@(Context.Request.Query["category"] == "Group")">Group</option>
                            <option value="Solo" selected="@(Context.Request.Query["category"] == "Solo")">Solo</option>
                        </select>
                    </div>

                    <!-- Price Range Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-currency-dollar"></i> Price Range
                        </label>
                        <div style="display: flex; gap: 0.5rem; min-width: 0;">
                            <input type="number" id="minPrice" name="minPrice" class="filter-input" placeholder="Min" min="0" style="flex: 1; min-width: 0;" value="@Context.Request.Query["minPrice"]">
                            <input type="number" id="maxPrice" name="maxPrice" class="filter-input" placeholder="Max" min="0" style="flex: 1; min-width: 0;" value="@Context.Request.Query["maxPrice"]">
                        </div>
                    </div>

                    <!-- Travel Date Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-calendar"></i> Travel Date
                        </label>
                        <input type="date" id="travelDate" name="travelDate" class="filter-input" value="@Context.Request.Query["travelDate"]">
                    </div>

                    <!-- On Sale Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-tag"></i> Special Offers
                        </label>
                        <div class="discount-checkbox">
                            <input type="checkbox" id="discountOnly" name="discountOnly" value="true" checked="@(Context.Request.Query["discountOnly"] == "true")">
                            <label for="discountOnly">Show discounted only</label>
                        </div>
                    </div>
                </div>

                <!-- Sort and Action Buttons -->
                <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-end;">
                    <div class="sort-group">
                        <label class="sort-label">
                            <i class="bi bi-arrow-down-up"></i> Sort By
                        </label>
                        <select id="sortBy" name="sortBy" class="filter-select">
                            <option value="" selected="@(Context.Request.Query["sortBy"] == "")">Default</option>
                            <option value="price-asc" selected="@(Context.Request.Query["sortBy"] == "price-asc")">Price: Low to High</option>
                            <option value="price-desc" selected="@(Context.Request.Query["sortBy"] == "price-desc")">Price: High to Low</option>
                            <option value="date" selected="@(Context.Request.Query["sortBy"] == "date")">Travel Date</option>
                            <option value="popular" selected="@(Context.Request.Query["sortBy"] == "popular")">Most Popular</option>
                        </select>
                    </div>

                    <div class="filter-buttons">
                        <button type="submit" class="btn-filter btn-apply" id="applyFilters">
                            <i class="bi bi-check-circle"></i> Apply Filters
                        </button>
                        <button type="button" class="btn-filter btn-reset" id="resetFilters">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Trips Grid -->
        <div class="trips-grid" id="tripsGrid">
            @foreach (var trip in Model)
            {
                <div class="trip-card" 
                     data-destination="@trip.Destination.ToLower()" 
                     data-country="@trip.Country.ToLower()" 
                     data-category="@trip.PackageType" 
                     data-price="@trip.DiscountPrice.HasValue ? trip.DiscountPrice.Value : trip.Price" 
                     data-start-date="@trip.ClosestStartDate.ToString("yyyy-MM-dd")"
                     data-is-discount="@(trip.DiscountPrice.HasValue && trip.DiscountPrice < trip.Price ? "true" : "false")">
                    <!-- Package Type Badge -->
                    <div class="package-badge">
                        <i class="bi bi-star-fill"></i> @trip.PackageType
                    </div>

                    <!-- Trip Image -->
                    <div class="trip-image-container">
                        @if (trip.HasImage)
                        {
                            <img src="@Url.Action("GetImage", "Dashboard", new { tripId = trip.TripID })" 
                                 alt="@trip.Destination" 
                                 class="trip-image" />
                        }
                        else
                        {
                            <div class="no-image-placeholder">
                                <i class="bi bi-image"></i>
                            </div>
                        }
                    </div>

                    <!-- Trip Details -->
                    <div class="trip-details">
                        <h3 class="trip-destination">@trip.Destination</h3>
                        <div class="trip-country">
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>@trip.Country</span>
                        </div>

                        <div class="trip-info">
                            <div class="info-item">
                                <i class="bi bi-calendar-check"></i>
                                <span>@trip.ClosestStartDate.ToString("MMM dd, yyyy") - @trip.ClosestEndDate.ToString("MMM dd, yyyy")</span>
                            </div>
                            <div class="info-item">
                                <i class="bi bi-person-badge"></i>
                                <span>@(trip.AgeLimit.HasValue ? $"{trip.AgeLimit}+" : "All ages")</span>
                            </div>
                            @if (trip.DateVariations.Any())
                            {
                                <div class="info-item" style="color: #6366f1; font-weight: 600;">
                                    <i class="bi bi-calendar-range"></i>
                                    <span>+@trip.DateVariations.Count more date@(trip.DateVariations.Count == 1 ? "" : "s")</span>
                                </div>
                            }
                        </div>

                        <p class="trip-description">@trip.Description</p>

                        <!-- Price Section -->
                        <div class="trip-price-section">
                            <div class="price-container">
                                @if (trip.DiscountPrice.HasValue && trip.DiscountPrice < trip.Price)
                                {
                                    <span class="original-price">$@trip.Price.ToString("N2")</span>
                                    <span class="trip-price">$@trip.DiscountPrice.Value.ToString("N2")</span>
                                }
                                else
                                {
                                    <span class="trip-price">$@trip.Price.ToString("N2")</span>
                                }
                            </div>

                            @if (trip.DiscountPrice.HasValue && trip.DiscountPrice < trip.Price)
                            {
                                var discount = (int)(((trip.Price - trip.DiscountPrice.Value) / trip.Price) * 100);
                                <div class="discount-badge">
                                    @discount% OFF
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Expand Button -->
                    <button class="expand-btn" data-trip-id="@trip.TripID" 
                            data-destination="@trip.Destination"
                            data-country="@trip.Country"
                            data-description="@trip.Description"
                            data-age-limit="@trip.AgeLimit"
                            data-start-date='@trip.ClosestStartDate.ToString("MMM dd, yyyy")'
                            data-end-date='@trip.ClosestEndDate.ToString("MMM dd, yyyy")'
                            data-duration="@((trip.ClosestEndDate - trip.ClosestStartDate).Days)"
                            data-rooms="@trip.ClosestAvailableRooms"
                            data-package="@trip.PackageType"
                            data-cancel-until='@trip.EffectiveCancellationEndDate.ToString("MMM dd, yyyy")'
                            data-price='@(trip.DiscountPrice.HasValue && trip.DiscountPrice < trip.Price ? trip.DiscountPrice.Value.ToString("N2") : trip.Price.ToString("N2"))'
                            data-image-count="@trip.ImageCount"
                            onclick="openTripModal(this, @trip.TripID)">
                        <span>View Details</span>
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            }
        </div>
    }
</div>

<script>
    const filterForm = document.getElementById('filterForm');
    const resetFiltersBtn = document.getElementById('resetFilters');

    // Reset filters
    resetFiltersBtn.addEventListener('click', function(e) {
        e.preventDefault();
        // Clear all form inputs
        filterForm.reset();
        // Redirect to filter page with no parameters to show all trips
        window.location.href = '@Url.Action("Search", "Filter")';
    });

    // Optional: Auto-submit on filter change for better UX (uncomment if you prefer instant filtering)
    // const filterInputs = filterForm.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], select, input[type="checkbox"]');
    // filterInputs.forEach(input => {
    //     input.addEventListener('change', () => filterForm.submit());
    // });

    // Trip Modal functionality
    let tripModal = null;
    let currentImages = [];
    let currentImageIndex = 0;

    function openTripModal(button, tripId) {
        const data = button.dataset;
        
        if (!tripModal) {
            createModal();
        }
        
        // Get card position for animation
        const card = button.closest('.trip-card');
        const cardRect = card.getBoundingClientRect();
        const modalContent = tripModal.querySelector('.modal-content');
        
        // Calculate position offset from center
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        const cardCenterX = cardRect.left + cardRect.width / 2;
        const cardCenterY = cardRect.top + cardRect.height / 2;
        
        const offsetX = cardCenterX - centerX;
        const offsetY = cardCenterY - centerY;
        
        // Set CSS custom properties for animation
        modalContent.style.setProperty('--start-x', `${offsetX}px`);
        modalContent.style.setProperty('--start-y', `${offsetY}px`);
        
        // Populate modal with trip data
        document.getElementById('modal-title').textContent = data.destination;
        document.getElementById('modal-location').innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${data.country}`;
        document.getElementById('modal-description').textContent = data.description;
        
        // Format dates properly
        const mainStartDate = new Date(data.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const mainEndDate = new Date(data.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        document.getElementById('modal-dates').textContent = `${mainStartDate} - ${mainEndDate}`;
        document.getElementById('modal-duration').textContent = `${data.duration} days`;
        const cancelUntil = data.cancelUntil || '';
        const cancelEl = document.getElementById('modal-cancel-until');
        if (cancelEl) cancelEl.textContent = cancelUntil || '7 days before start';
        document.getElementById('modal-rooms').textContent = `${data.rooms} rooms`;
        document.getElementById('modal-package').textContent = data.package;
        document.getElementById('modal-price').textContent = `$${data.price}`;
        
        // Store trip ID for actions
        tripModal.dataset.tripId = tripId;
        tripModal.dataset.destination = data.destination;
        tripModal.dataset.mainStartDate = data.startDate;
        tripModal.dataset.mainEndDate = data.endDate;
        tripModal.dataset.mainRooms = data.rooms;
        tripModal.dataset.mainDuration = data.duration;
        // Configure modal quantity control
        try {
            const roomsCount = parseInt(data.rooms || '1', 10) || 1;
            const qtyControl = tripModal.querySelector('#modal-qty-control');
            const qtyDisplay = tripModal.querySelector('#modal-qty-display');
            const roomsHint = tripModal.querySelector('#modal-rooms-hint');
            if (qtyControl && qtyDisplay) {
                qtyControl.dataset.max = roomsCount;
                qtyDisplay.value = '1';
                roomsHint.textContent = `${roomsCount} available`;
                // initialize buttons disabled state
                const btnInc = qtyControl.querySelector('.qty-increase');
                const btnDec = qtyControl.querySelector('.qty-decrease');
                if (btnInc) btnInc.disabled = false;
                if (btnDec) btnDec.disabled = true;
            }
        } catch (e) { console.error(e); }
        
        // Load images
        loadCarouselImages(tripId);
        
        // Load and display date variations
        loadDateVariations(tripId);
        
        // Show modal with animation
        tripModal.classList.add('active');
        modalContent.classList.add('expand-animation');
        document.body.style.overflow = 'hidden';
        
        // Remove animation class after it completes
        setTimeout(() => {
            modalContent.classList.remove('expand-animation');
        }, 500);
    }

    function createModal() {
        tripModal = document.createElement('div');
        tripModal.className = 'trip-modal';
        tripModal.innerHTML = `
            <div class="modal-content">
                <button class="modal-close" onclick="closeTripModal()">
                    <i class="bi bi-x"></i>
                </button>
                
                <div class="modal-trip-header">
                    <h2 class="modal-trip-title" id="modal-title"></h2>
                    <div class="modal-trip-location" id="modal-location"></div>
                    <p class="modal-trip-description" id="modal-description"></p>
                </div>
                
                <div class="photo-carousel">
                    <div class="carousel-main">
                        <div class="carousel-loading">Loading photos...</div>
                        <button class="carousel-arrow prev" onclick="prevImage()" style="display:none;">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="carousel-arrow next" onclick="nextImage()" style="display:none;">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <div class="carousel-counter" style="display:none;"></div>
                    </div>
                    <div class="carousel-thumbnails"></div>
                </div>
                
                <div class="additional-details">
                    <div class="detail-item">
                        <strong><i class="bi bi-calendar-event"></i> Travel Dates</strong>
                        <span id="modal-dates"></span>
                    </div>
                    <div class="detail-item" style="background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); border-color:#d1fae5;">
                        <strong><i class="bi bi-shield-check"></i> Free Cancellation Until</strong>
                        <span id="modal-cancel-until"></span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="bi bi-clock-history"></i> Duration</strong>
                        <span id="modal-duration"></span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="bi bi-door-open"></i> Available Rooms</strong>
                        <span id="modal-rooms"></span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="bi bi-tag"></i> Package Type</strong>
                        <span id="modal-package"></span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="bi bi-currency-dollar"></i> Price</strong>
                        <span id="modal-price"></span>
                    </div>
                </div>
                
                <div class="modal-qty-row" style="display:flex;align-items:center;justify-content:center;padding:1rem 1.5rem;gap:1rem;">
                    <div class="qty-label" style="color:#475569;font-weight:600;">Quantity</div>
                    <div class="qty-control" id="modal-qty-control" data-max="1" style="display:flex;align-items:center;gap:0.5rem;background:linear-gradient(180deg,#fff,#f8fafc);padding:0.25rem;border-radius:0.75rem;box-shadow:0 6px 18px rgba(2,6,23,0.06);">
                        <button type="button" class="qty-btn qty-decrease" onclick="changeModalQty(-1)" style="background:transparent;border:none;font-size:1.4rem;padding:0.25rem 0.6rem;color:#475569;">âˆ’</button>
                        <input type="text" id="modal-qty-display" value="1" readonly style="width:48px;text-align:center;border:none;background:transparent;font-weight:700;color:#111827;font-size:1rem;">
                        <button type="button" class="qty-btn qty-increase" onclick="changeModalQty(1)" style="background:transparent;border:none;font-size:1.2rem;padding:0.25rem 0.6rem;color:#475569;">+</button>
                    </div>
                    <div id="modal-rooms-hint" style="color:#64748b;font-size:0.9rem;">&nbsp;</div>
                </div>

                <div id="modal-date-variations" class="date-variations-section" style="display:none;">
                    <h4 style="color:#1e293b;font-size:1.2rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                        <i class="bi bi-calendar-range"></i> Available Date Options
                    </h4>
                    <div id="date-variations-list" class="date-variations-list"></div>
                </div>

                <div class="trip-actions">
                    <button class="btn-action btn-add-cart" onclick="addToCartFromModal()">
                        <i class="bi bi-cart-plus"></i>
                        Add to Cart
                    </button>
                    <button class="btn-action btn-book-now" onclick="bookNowFromModal()">
                        <i class="bi bi-lightning-charge"></i>
                        Book Now
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(tripModal);
        
        // Close on background click
        tripModal.addEventListener('click', (e) => {
            if (e.target === tripModal) closeTripModal();
        });
    }

    function closeTripModal() {
        if (tripModal) {
            tripModal.classList.remove('active');
            document.body.style.overflow = '';
            currentImages = [];
            currentImageIndex = 0;
        }
    }

    async function loadCarouselImages(tripId) {
        const carouselMain = tripModal.querySelector('.carousel-main');
        const thumbnailsContainer = tripModal.querySelector('.carousel-thumbnails');
        const prevBtn = tripModal.querySelector('.carousel-arrow.prev');
        const nextBtn = tripModal.querySelector('.carousel-arrow.next');
        const counter = tripModal.querySelector('.carousel-counter');
        
        try {
            const response = await fetch(`/Dashboard/GetAllImages?tripId=${tripId}`);
            const data = await response.json();
            
            if (data.images && data.images.length > 0) {
                currentImages = data.images;
                currentImageIndex = 0;
                
                // Clear loading message
                carouselMain.innerHTML = '';
                
                // Create main images
                data.images.forEach((img, index) => {
                    const imgElement = document.createElement('img');
                    imgElement.src = img.imageUrl;
                    imgElement.alt = `Trip photo ${index + 1}`;
                    imgElement.className = 'carousel-image' + (index === 0 ? ' active' : '');
                    carouselMain.appendChild(imgElement);
                });
                
                // Create thumbnails
                thumbnailsContainer.innerHTML = '';
                data.images.forEach((img, index) => {
                    const thumb = document.createElement('img');
                    thumb.src = img.imageUrl;
                    thumb.alt = `Thumbnail ${index + 1}`;
                    thumb.className = 'thumbnail' + (index === 0 ? ' active' : '');
                    thumb.onclick = () => showImage(index);
                    thumbnailsContainer.appendChild(thumb);
                });
                
                // Show controls if more than one image
                if (data.images.length > 1) {
                    prevBtn.style.display = 'flex';
                    nextBtn.style.display = 'flex';
                    counter.style.display = 'block';
                    updateCounter();
                }
                
                // Add arrow controls to carousel main
                carouselMain.appendChild(prevBtn);
                carouselMain.appendChild(nextBtn);
                carouselMain.appendChild(counter);
            } else {
                carouselMain.innerHTML = '<div class="carousel-empty">No photos available</div>';
            }
        } catch (error) {
            console.error('Error loading images:', error);
            carouselMain.innerHTML = '<div class="carousel-empty">Failed to load photos</div>';
        }
    }

    function showImage(index) {
        const images = tripModal.querySelectorAll('.carousel-image');
        const thumbnails = tripModal.querySelectorAll('.thumbnail');
        
        images.forEach(img => img.classList.remove('active'));
        thumbnails.forEach(thumb => thumb.classList.remove('active'));
        
        images[index].classList.add('active');
        thumbnails[index].classList.add('active');
        
        currentImageIndex = index;
        updateCounter();
        
        // Scroll thumbnail into view
        thumbnails[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }

    function prevImage() {
        const newIndex = currentImageIndex === 0 ? currentImages.length - 1 : currentImageIndex - 1;
        showImage(newIndex);
    }

    function nextImage() {
        const newIndex = currentImageIndex === currentImages.length - 1 ? 0 : currentImageIndex + 1;
        showImage(newIndex);
    }

    function updateCounter() {
        const counter = tripModal.querySelector('.carousel-counter');
        if (counter && currentImages.length > 0) {
            counter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (!tripModal || !tripModal.classList.contains('active')) return;
        
        if (e.key === 'Escape') {
            closeTripModal();
        } else if (e.key === 'ArrowLeft') {
            prevImage();
        } else if (e.key === 'ArrowRight') {
            nextImage();
        }
    });

    // Load and display date variations
    function loadDateVariations(tripId) {
        const section = document.getElementById('modal-date-variations');
        const list = document.getElementById('date-variations-list');
        
        if (!section || !list) return;
        
        // Find the trip in the model
        const trips = @Html.Raw(Json.Serialize(Model));
        const trip = trips.find(t => t.tripID === tripId);
        
        if (!trip) {
            section.style.display = 'none';
            return;
        }
        
        // Get main trip dates from modal dataset
        const mainStartDate = new Date(tripModal.dataset.mainStartDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const mainEndDate = new Date(tripModal.dataset.mainEndDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const mainRooms = parseInt(tripModal.dataset.mainRooms || '0');
        const mainDuration = parseInt(tripModal.dataset.mainDuration || '0');
        
        // Always show the section (main date + variations)
        section.style.display = 'block';
        
        // Create main date option (Option 1)
        let optionsHtml = `
            <div class="date-variation-item" onclick="selectDateVariation(-1, ${mainRooms}, '${mainStartDate}', '${mainEndDate}', ${mainDuration})" style="cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="selected-date" value="-1" checked style="margin-right: 0.75rem;" />
                <div class="date-variation-info">
                    <div>
                        <i class="bi bi-calendar-check"></i>
                        <strong>Option 1 (Main):</strong>
                    </div>
                    <div>
                        <i class="bi bi-calendar-event"></i>
                        ${mainStartDate} - ${mainEndDate}
                    </div>
                    <div>
                        <i class="bi bi-clock"></i>
                        ${mainDuration} days
                    </div>
                    <div>
                        <i class="bi bi-door-open"></i>
                        ${mainRooms} rooms available
                    </div>
                </div>
            </div>
        `;
        
        // Add additional date variations (Option 2, 3, etc.) if they exist
        if (trip.dateVariations && trip.dateVariations.length > 0) {
            optionsHtml += trip.dateVariations.map((dateVar, index) => {
            const startDate = new Date(dateVar.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const endDate = new Date(dateVar.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const days = Math.ceil((new Date(dateVar.endDate) - new Date(dateVar.startDate)) / (1000 * 60 * 60 * 24));
            
            return `
                <div class="date-variation-item" onclick="selectDateVariation(${index}, ${dateVar.availableRooms}, '${startDate}', '${endDate}', ${days})" style="cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="selected-date" value="${index}" style="margin-right: 0.75rem;" />
                    <div class="date-variation-info">
                        <div>
                            <i class="bi bi-calendar-check"></i>
                            <strong>Option ${index + 2}:</strong>
                        </div>
                        <div>
                            <i class="bi bi-calendar-event"></i>
                            ${startDate} - ${endDate}
                        </div>
                        <div>
                            <i class="bi bi-clock"></i>
                            ${days} days
                        </div>
                        <div>
                            <i class="bi bi-door-open"></i>
                            ${dateVar.availableRooms} rooms available
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        }
        
        list.innerHTML = optionsHtml;
    }

    function selectDateVariation(index, rooms, startDate, endDate, days) {
        // Update the radio button by value, not by position
        const radios = document.querySelectorAll('input[name="selected-date"]');
        radios.forEach((radio) => {
            radio.checked = (parseInt(radio.value) === index);
        });
        
        // Update modal display with selected date
        document.getElementById('modal-dates').textContent = `${startDate} - ${endDate}`;
        document.getElementById('modal-duration').textContent = `${days} days`;
        document.getElementById('modal-rooms').textContent = `${rooms} rooms`;
        
        // Update quantity control max
        const qtyControl = tripModal.querySelector('#modal-qty-control');
        const qtyDisplay = tripModal.querySelector('#modal-qty-display');
        if (qtyControl && qtyDisplay) {
            qtyControl.dataset.max = rooms;
            const currentQty = parseInt(qtyDisplay.value || '1', 10);
            if (currentQty > rooms) {
                qtyDisplay.value = rooms;
            }
        }
        
        // Store selected date index
        if (tripModal) {
            tripModal.dataset.selectedDateIndex = index;
        }
    }

    function addToCartFromModal() {
        const tripId = parseInt(tripModal.dataset.tripId);
        const destination = tripModal.dataset.destination;
        const qtyDisplay = tripModal.querySelector('#modal-qty-display');
        const quantity = qtyDisplay ? parseInt(qtyDisplay.value || '1', 10) : 1;
        const selectedDateIndex = parseInt(tripModal.dataset.selectedDateIndex || '-1', 10);
        addToCart(tripId, destination, quantity, selectedDateIndex);
    }

    function bookNowFromModal() {
        const tripId = parseInt(tripModal.dataset.tripId);
        const qtyDisplay = tripModal.querySelector('#modal-qty-display');
        const quantity = qtyDisplay ? parseInt(qtyDisplay.value || '1', 10) : 1;
        // Close trip modal so checkout modal is fully visible
        closeTripModal();
        openPaymentModal(tripId, quantity);
    }

    function changeModalQty(delta) {
        if (!tripModal) return;
        const control = tripModal.querySelector('#modal-qty-control');
        const display = tripModal.querySelector('#modal-qty-display');
        if (!control || !display) return;
        const max = parseInt(control.dataset.max || '1', 10) || 1;
        let value = parseInt(display.value || '1', 10) || 1;
        value += delta;
        if (value < 1) value = 1;
        if (value > max) value = max;
        display.value = String(value);
        // Update button disabled state
        const btnInc = control.querySelector('.qty-increase');
        const btnDec = control.querySelector('.qty-decrease');
        if (btnInc) btnInc.disabled = value >= max;
        if (btnDec) btnDec.disabled = value <= 1;
    }

    // Trip card expansion functionality
    const loadedGalleries = new Set();

    function toggleCard(button, tripId) {
        const card = button.closest('.trip-card');
        const isExpanded = card.classList.contains('expanded');
        
        if (isExpanded) {
            // Collapse the card
            card.classList.remove('expanded');
            button.querySelector('span').textContent = 'View Details';
        } else {
            // Expand the card
            card.classList.add('expanded');
            button.querySelector('span').textContent = 'Hide Details';
            
            // Load gallery if not already loaded
            if (!loadedGalleries.has(tripId)) {
                loadGallery(tripId);
                loadedGalleries.add(tripId);
            }
        }
    }

    async function loadGallery(tripId) {
        const galleryContainer = document.getElementById(`gallery-${tripId}`);
        
        try {
            const response = await fetch(`/Dashboard/GetAllImages?tripId=${tripId}`);
            const data = await response.json();
            
            if (data.images && data.images.length > 0) {
                galleryContainer.innerHTML = '';
                data.images.forEach(img => {
                    const imgElement = document.createElement('img');
                    imgElement.src = img.imageUrl;
                    imgElement.alt = 'Trip photo';
                    imgElement.className = 'gallery-image';
                    imgElement.onclick = () => openLightbox(img.imageUrl);
                    galleryContainer.appendChild(imgElement);
                });
            } else {
                galleryContainer.innerHTML = '<div class="gallery-empty">No photos available for this trip</div>';
            }
        } catch (error) {
            console.error('Error loading gallery:', error);
            galleryContainer.innerHTML = '<div class="gallery-empty">Failed to load photos</div>';
        }
    }

    // Lightbox functionality
    let lightbox = null;

    function openLightbox(imageUrl) {
        if (!lightbox) {
            lightbox = document.createElement('div');
            lightbox.className = 'lightbox';
            lightbox.innerHTML = `
                <span class="lightbox-close">&times;</span>
                <img class="lightbox-content" alt="Full size image">
            `;
            document.body.appendChild(lightbox);
            
            lightbox.querySelector('.lightbox-close').onclick = closeLightbox;
            lightbox.onclick = (e) => {
                if (e.target === lightbox) closeLightbox();
            };
        }
        
        lightbox.querySelector('.lightbox-content').src = imageUrl;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        if (lightbox) {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    // Close lightbox on ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeLightbox();
    });

    // Shopping cart functionality
    async function addToCart(tripId, destination, quantity = 1, selectedDateIndex = -1) {
        try {
            const response = await fetch('/User/AddToCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tripId: tripId, quantity, selectedDateIndex })
            });

            const data = await response.json();
            
            if (data.success) {
                if (data.onWaitlist) {
                    showNotification(data.message, 'info');
                } else {
                    showNotification(data.message, 'success');
                    
                    // Update available rooms count on the card
                    if (data.tripId && data.availableRooms !== undefined) {
                        const card = document.querySelector(`[data-trip-id="${data.tripId}"]`);
                        if (card) {
                            card.setAttribute('data-rooms', data.availableRooms);
                        }
                    }
                }
            } else {
                if (data.onWaitlist) {
                    showNotification(data.message, 'info');
                } else {
                    showNotification(data.message, 'error');
                }
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            showNotification('Failed to add trip to cart. Please try again.', 'error');
        }
    }

    function bookNow(tripId, quantity = 1) {
        openPaymentModal(tripId, quantity);
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #6366f1, #4f46e5)'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            font-weight: 600;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Add animation keyframes
    const style = document.createElement('style');
    style.textContent = `
        @@keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @@keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
</script>

